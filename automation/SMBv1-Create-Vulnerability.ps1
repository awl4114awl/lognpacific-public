<#
.SYNOPSIS
    Intentionally enables SMBv1 for vulnerability-creation labs.

.DESCRIPTION
    This script enables the deprecated and insecure SMBv1 protocol on Windows,
    re-creates insecure registry settings, and forces the SMBv1 client/server
    components to start.

    ⚠️ This script intentionally weakens system security.
    Use ONLY in isolated lab environments.
#>

Write-Output "`n=== Enabling SMBv1 (Intentional Vulnerability) ===`n"

# Enable SMBv1 Windows Feature
try {
    Write-Output "[*] Enabling SMBv1 Windows Feature..."
    Enable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart -ErrorAction Stop
    Write-Output "[+] SMBv1 feature enabled."
}
catch {
    Write-Warning "[-] Failed to enable SMBv1 feature: $($_.Exception.Message)"
}

# Registry paths
$smbClientPath        = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters"
$smbClientDriverPath  = "HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10"
$smbServerPath        = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters"

# Enable SMBv1 Client
Write-Output "`n[*] Enabling SMBv1 Client settings..."

if (Test-Path $smbClientPath) {
    Set-ItemProperty -Path $smbClientPath -Name "AllowInsecureGuestAuth" -Value 1 -Force
    Write-Output "[+] AllowInsecureGuestAuth enabled."
} else {
    Write-Warning "[-] SMBv1 Client registry path missing: $smbClientPath"
}

if (Test-Path $smbClientDriverPath) {
    Set-ItemProperty -Path $smbClientDriverPath -Name "Start" -Value 2 -Force
    Write-Output "[+] SMBv1 Client driver forced to start."
} else {
    Write-Warning "[-] SMBv1 Client driver path missing: $smbClientDriverPath"
}

# Enable SMBv1 Server
Write-Output "`n[*] Enabling SMBv1 Server settings..."

if (Test-Path $smbServerPath) {
    Set-ItemProperty -Path $smbServerPath -Name "SMB1" -Value 1 -Force
    Write-Output "[+] SMBv1 server enabled."
} else
{
    Write-Warning "[-] SMBv1 Server registry path missing: $smbServerPath"
}

Write-Output "`n=== SMBv1 Vulnerability Creation Complete ==="
Write-Output "A restart may be required for all changes to take full effect."
