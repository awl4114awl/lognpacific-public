<#
.SYNOPSIS
    Remediates STIG ID WN11-AC-000015 by enforcing STIG-compliant Account Lockout Policy settings.

.DESCRIPTION
    Configures local Account Lockout Policy using supported Windows account policy commands (net accounts).
    Windows enforces dependency rules between these settings, so the script applies them in a safe order:
      1) Lockout threshold (enable lockout)
      2) Lockout duration
      3) Lockout observation window (reset counter)

    Dependency rule (when lockout is enabled):
      LockoutDuration must be >= LockoutWindow

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-26
    Last Modified   : 2025-12-26
    Version         : 1.1
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-AC-000015
    File Name       : __template_remediation-STIG-ID-WN11-AC-000015.ps1

.TESTED ON
    Systems Tested  : Windows 11 Pro

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-WN11-AC-000015.ps1

.RESTART
    A system restart is recommended after applying account lockout policy changes to ensure all components
    consistently recognize the updated security policy.
#>

# =========================
# Admin Check
# =========================
$IsAdmin = ([Security.Principal.WindowsPrincipal] `
    [Security.Principal.WindowsIdentity]::GetCurrent() `
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $IsAdmin) {
    Write-Host "[!] This script must be run as Administrator." -ForegroundColor Red
    exit 1
}

# =========================
# Desired STIG-Compliant Values
# =========================
# NOTE: Adjust these values if your baseline requires different numbers.
$DesiredLockoutThreshold    = 10   # invalid attempts before lockout
$DesiredResetLockoutCount   = 15   # observation window (minutes)
$DesiredLockoutDuration     = 15   # lockout duration (minutes) - must be >= observation window

if ($DesiredLockoutDuration -lt $DesiredResetLockoutCount) {
    Write-Host "[!] Invalid configuration: LockoutDuration must be >= Lockout observation window." -ForegroundColor Red
    Write-Host "    LockoutDuration: $DesiredLockoutDuration, Observation window: $DesiredResetLockoutCount"
    exit 1
}

# =========================
# Helper: Read Current Settings
# =========================
function Get-NetAccountsLockoutSettings {
    $out = net accounts 2>$null
    if (-not $out) { return $null }

    $settings = [ordered]@{
        LockoutThreshold        = $null
        LockoutDurationMinutes  = $null
        LockoutWindowMinutes    = $null
        Raw                     = $out
    }

    foreach ($line in $out) {
        if ($line -match 'Lockout threshold:\s+(\d+)') {
            $settings.LockoutThreshold = [int]$matches[1]
        }
        elseif ($line -match 'Lockout duration \(minutes\):\s+(\d+)') {
            $settings.LockoutDurationMinutes = [int]$matches[1]
        }
        elseif ($line -match 'Lockout observation window \(minutes\):\s+(\d+)') {
            $settings.LockoutWindowMinutes = [int]$matches[1]
        }
    }

    return $settings
}

function Invoke-NetAccountsCommand {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Command,
        [Parameter(Mandatory=$true)]
        [string]$ErrorMessage
    )

    $null = cmd.exe /c $Command
    if ($LASTEXITCODE -ne 0) {
        Write-Host "[!] $ErrorMessage" -ForegroundColor Red
        Write-Host "    Command: $Command"
        exit 1
    }
}

# =========================
# Display Current Settings
# =========================
Write-Host "============================================================"
Write-Host "WN11-AC-000015 Remediation - Current Account Lockout Settings"
Write-Host "============================================================"

$current = Get-NetAccountsLockoutSettings
if (-not $current) {
    Write-Host "[!] Unable to read current account policy using 'net accounts'." -ForegroundColor Red
    exit 1
}

Write-Host "Current:"
Write-Host "  Lockout threshold               : $($current.LockoutThreshold)"
Write-Host "  Lockout duration (minutes)      : $($current.LockoutDurationMinutes)"
Write-Host "  Lockout observation window (min): $($current.LockoutWindowMinutes)"
Write-Host ""

# =========================
# Apply Settings (Order Matters)
# =========================
Write-Host "Applying STIG-compliant Account Lockout Policy values..."
Write-Host "  Target lockout threshold        : $DesiredLockoutThreshold"
Write-Host "  Target lockout duration (min)   : $DesiredLockoutDuration"
Write-Host "  Target observation window (min) : $DesiredResetLockoutCount"
Write-Host ""

# 1) Enable lockout (non-zero threshold)
Invoke-NetAccountsCommand -Command "net accounts /lockoutthreshold:$DesiredLockoutThreshold" `
    -ErrorMessage "Failed to set lockout threshold."

# 2) Set lockout duration FIRST (must be >= observation window)
Invoke-NetAccountsCommand -Command "net accounts /lockoutduration:$DesiredLockoutDuration" `
    -ErrorMessage "Failed to set lockout duration."

# 3) Set observation window (reset counter) AFTER duration
Invoke-NetAccountsCommand -Command "net accounts /lockoutwindow:$DesiredResetLockoutCount" `
    -ErrorMessage "Failed to set lockout observation window (reset counter)."

Write-Host "[+] Account lockout policy commands executed successfully."
Write-Host ""

# =========================
# Verify Effective Settings
# =========================
Write-Host "============================================================"
Write-Host "Verification - Effective Account Lockout Settings"
Write-Host "============================================================"

$updated = Get-NetAccountsLockoutSettings
if (-not $updated) {
    Write-Host "[!] Unable to read updated account policy using 'net accounts'." -ForegroundColor Red
    exit 1
}

Write-Host "Updated:"
Write-Host "  Lockout threshold               : $($updated.LockoutThreshold)"
Write-Host "  Lockout duration (minutes)      : $($updated.LockoutDurationMinutes)"
Write-Host "  Lockout observation window (min): $($updated.LockoutWindowMinutes)"
Write-Host ""

# Sanity checks (non-authoritative)
$issues = @()

if ($updated.LockoutThreshold -eq 0) { $issues += "Lockout threshold is 0 (lockout disabled)." }
if ($updated.LockoutDurationMinutes -eq 0) { $issues += "Lockout duration is 0 minutes (immediate unlock)." }
if (($updated.LockoutThreshold -ne 0) -and ($updated.LockoutDurationMinutes -lt $updated.LockoutWindowMinutes)) {
    $issues += "Lockout duration is less than observation window (invalid relationship)."
}

if ($issues.Count -gt 0) {
    Write-Host "[!] Potential issues detected:" -ForegroundColor Yellow
    $issues | ForEach-Object { Write-Host "    - $_" }
    Write-Host ""
} else {
    Write-Host "[+] Lockout policy values appear consistent (basic sanity checks passed)." -ForegroundColor Green
    Write-Host ""
}

Write-Host "============================================================"
Write-Host "Completed - WN11-AC-000015 Remediation"
Write-Host "============================================================"
Write-Host "Restart recommended to ensure all components consistently recognize the updated security policy."
