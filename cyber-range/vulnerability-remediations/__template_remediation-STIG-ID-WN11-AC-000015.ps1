<#
.SYNOPSIS
    Remediates STIG ID WN11-AC-000015 by enforcing a STIG-compliant Account Lockout Duration configuration.

.DESCRIPTION
    This script configures local Account Lockout Policy settings using supported Windows account policy commands.
    It enforces a lockout duration that meets STIG requirements and preserves the required policy dependencies
    between:
      - Lockout threshold
      - Lockout duration
      - Lockout observation window (reset counter)

    IMPORTANT:
    - Windows enforces dependency rules between these values. For example, LockoutDuration must be
      greater than or equal to ResetLockoutCount when lockout is enabled.
    - If lockout is currently disabled (threshold = 0), the script enables lockout first.

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-26
    Last Modified   : 2025-12-26
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-AC-000015
    File Name       : __template_remediation-STIG-ID-WN11-AC-000015.ps1

.TESTED ON
    Systems Tested  : Windows 11 Pro

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-WN11-AC-000015.ps1

.RESTART
    A system restart is recommended after applying account lockout policy changes to ensure all components
    consistently recognize the updated security policy.

#>

# =========================
# Admin Check
# =========================
$IsAdmin = ([Security.Principal.WindowsPrincipal] `
    [Security.Principal.WindowsIdentity]::GetCurrent() `
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $IsAdmin) {
    Write-Host "[!] This script must be run as Administrator." -ForegroundColor Red
    exit 1
}

# =========================
# Desired STIG-Compliant Values
# =========================
# NOTE: Adjust these values if your STIG baseline requires different numbers.
# The only hard rule we must enforce is: LockoutDuration >= ResetLockoutCount (when lockout is enabled).
$DesiredLockoutThreshold    = 10   # Number of invalid logon attempts before lockout
$DesiredResetLockoutCount   = 15   # Observation window (minutes)
$DesiredLockoutDuration     = 15   # Lockout duration (minutes) - must be >= ResetLockoutCount

if ($DesiredLockoutDuration -lt $DesiredResetLockoutCount) {
    Write-Host "[!] Invalid configuration: LockoutDuration must be >= ResetLockoutCount." -ForegroundColor Red
    Write-Host "    LockoutDuration: $DesiredLockoutDuration, ResetLockoutCount: $DesiredResetLockoutCount"
    exit 1
}

# =========================
# Helper: Read Current Settings
# =========================
function Get-NetAccountsLockoutSettings {
    $out = net accounts 2>$null
    if (-not $out) { return $null }

    $settings = [ordered]@{
        LockoutThreshold        = $null
        LockoutDurationMinutes  = $null
        LockoutWindowMinutes    = $null
        Raw                     = $out
    }

    foreach ($line in $out) {
        if ($line -match 'Lockout threshold:\s+(\d+)') {
            $settings.LockoutThreshold = [int]$matches[1]
        }
        elseif ($line -match 'Lockout duration \(minutes\):\s+(\d+)') {
            $settings.LockoutDurationMinutes = [int]$matches[1]
        }
        elseif ($line -match 'Lockout observation window \(minutes\):\s+(\d+)') {
            $settings.LockoutWindowMinutes = [int]$matches[1]
        }
    }

    return $settings
}

# =========================
# Display Current Settings
# =========================
Write-Host "============================================================"
Write-Host "WN11-AC-000015 Remediation - Current Account Lockout Settings"
Write-Host "============================================================"

$current = Get-NetAccountsLockoutSettings
if (-not $current) {
    Write-Host "[!] Unable to read current account policy using 'net accounts'." -ForegroundColor Red
    exit 1
}

Write-Host "Current:"
Write-Host "  Lockout threshold               : $($current.LockoutThreshold)"
Write-Host "  Lockout duration (minutes)      : $($current.LockoutDurationMinutes)"
Write-Host "  Lockout observation window (min): $($current.LockoutWindowMinutes)"
Write-Host ""

# =========================
# Apply Settings (Order Matters)
# =========================
Write-Host "Applying STIG-compliant Account Lockout Policy values..."
Write-Host "  Target lockout threshold        : $DesiredLockoutThreshold"
Write-Host "  Target reset lockout count (min): $DesiredResetLockoutCount"
Write-Host "  Target lockout duration (min)   : $DesiredLockoutDuration"
Write-Host ""

# 1) Ensure lockout is enabled with a non-zero threshold (required for duration settings to be meaningful)
$cmd1 = "net accounts /lockoutthreshold:$DesiredLockoutThreshold"
$null = cmd.exe /c $cmd1
if ($LASTEXITCODE -ne 0) {
    Write-Host "[!] Failed to set lockout threshold." -ForegroundColor Red
    Write-Host "    Command: $cmd1"
    exit 1
}

# 2) Set observation window (reset counter)
$cmd2 = "net accounts /lockoutwindow:$DesiredResetLockoutCount"
$null = cmd.exe /c $cmd2
if ($LASTEXITCODE -ne 0) {
    Write-Host "[!] Failed to set lockout observation window (reset counter)." -ForegroundColor Red
    Write-Host "    Command: $cmd2"
    exit 1
}

# 3) Set lockout duration (must be >= reset counter)
$cmd3 = "net accounts /lockoutduration:$DesiredLockoutDuration"
$null = cmd.exe /c $cmd3
if ($LASTEXITCODE -ne 0) {
    Write-Host "[!] Failed to set lockout duration." -ForegroundColor Red
    Write-Host "    Command: $cmd3"
    Write-Host "    Note: LockoutDuration must be >= ResetLockoutCount when lockout is enabled."
    exit 1
}

Write-Host "[+] Account lockout policy commands executed successfully."
Write-Host ""

# =========================
# Verify Effective Settings
# =========================
Write-Host "============================================================"
Write-Host "Verification - Effective Account Lockout Settings"
Write-Host "============================================================"

$updated = Get-NetAccountsLockoutSettings
if (-not $updated) {
    Write-Host "[!] Unable to read updated account policy using 'net accounts'." -ForegroundColor Red
    exit 1
}

Write-Host "Updated:"
Write-Host "  Lockout threshold               : $($updated.LockoutThreshold)"
Write-Host "  Lockout duration (minutes)      : $($updated.LockoutDurationMinutes)"
Write-Host "  Lockout observation window (min): $($updated.LockoutWindowMinutes)"
Write-Host ""

# Basic compliance sanity checks (non-authoritative; STIG scanner is source of truth)
$complianceIssues = @()

if ($updated.LockoutThreshold -eq 0) {
    $complianceIssues += "Lockout threshold is 0 (lockout disabled)."
}
if ($updated.LockoutDurationMinutes -eq 0) {
    $complianceIssues += "Lockout duration is 0 minutes (immediate unlock)."
}
if (($updated.LockoutDurationMinutes -ne $null) -and ($updated.LockoutWindowMinutes -ne $null) -and
    ($updated.LockoutThreshold -ne 0) -and ($updated.LockoutDurationMinutes -lt $updated.LockoutWindowMinutes)) {
    $complianceIssues += "Lockout duration is less than observation window (invalid/noncompliant relationship)."
}

if ($complianceIssues.Count -gt 0) {
    Write-Host "[!] Potential compliance issues detected:" -ForegroundColor Yellow
    $complianceIssues | ForEach-Object { Write-Host "    - $_" }
    Write-Host ""
} else {
    Write-Host "[+] Lockout policy values appear consistent and STIG-aligned (basic sanity checks passed)." -ForegroundColor Green
    Write-Host ""
}

Write-Host "============================================================"
Write-Host "Completed - WN11-AC-000015 Remediation"
Write-Host "============================================================"
Write-Host "Restart recommended to ensure all components consistently recognize the updated security policy."
