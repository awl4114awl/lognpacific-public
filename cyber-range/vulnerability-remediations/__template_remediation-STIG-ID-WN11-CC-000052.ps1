<#
.SYNOPSIS
    Remediates ECC Curve Order by enforcing NistP384 then NistP256.

.DESCRIPTION
    Applies the ECC curve order in TWO places:
      1) Registry-based Group Policy location (policy enforcement):
         HKLM\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002
         Value: EccCurves (REG_MULTI_SZ)

      2) Local Schannel ECC location (local machine configuration):
         HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\ECC
         Value: CurveOrder (REG_SZ)

    Notes:
      - No gpupdate is invoked.
      - A reboot is recommended so Schannel/SSL consumers fully apply the change.

.NOTES
    Author          : Jordan Calvert
    Date Created    : 2025-12-23
    Version         : 1.0
    STIG-ID         : (Add your STIG ID here)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-XXXX.ps1

#>

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

function Assert-Admin {
    $isAdmin = ([Security.Principal.WindowsPrincipal] `
        [Security.Principal.WindowsIdentity]::GetCurrent()
    ).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

    if (-not $isAdmin) { throw "This script must be run as Administrator." }
}

function Ensure-Key {
    param([Parameter(Mandatory)][string]$Path)
    if (-not (Test-Path $Path)) {
        New-Item -Path $Path -Force | Out-Null
    }
}

function Read-Value {
    param(
        [Parameter(Mandatory)][string]$Path,
        [Parameter(Mandatory)][string]$Name
    )
    if (-not (Test-Path $Path)) { return $null }
    $props = Get-ItemProperty -Path $Path -ErrorAction SilentlyContinue
    if ($null -eq $props) { return $null }
    if ($props.PSObject.Properties.Name -contains $Name) { return $props.$Name }
    return $null
}

Assert-Admin

# --- Desired curve order (STIG requirement) ---
$DesiredCurves = @("NistP384", "NistP256")
$DesiredCurveOrderString = "NistP384, NistP256"

# --- Targets ---
$PolicyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\Configuration\SSL\00010002"
$PolicyValueName = "EccCurves"         # REG_MULTI_SZ

$LocalPath  = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\ECC"
$LocalValueName = "CurveOrder"         # REG_SZ

Write-Host "=== ECC Curve Order Remediation ==="
Write-Host "[*] Desired order: $DesiredCurveOrderString"
Write-Host ""

# --- Show current state ---
Write-Host "[*] Current (before) state:"
$beforePolicy = Read-Value -Path $PolicyPath -Name $PolicyValueName
$beforeLocal  = Read-Value -Path $LocalPath  -Name $LocalValueName

Write-Host "    Policy ($PolicyPath\$PolicyValueName): $(
    if ($null -eq $beforePolicy) { '<not set>' } else { ($beforePolicy -join ', ') }
)"
Write-Host "    Local  ($LocalPath\$LocalValueName): $(
    if ($null -eq $beforeLocal) { '<not set>' } else { $beforeLocal }
)"
Write-Host ""

# --- Apply policy-level (registry-based GPO) ---
Ensure-Key -Path $PolicyPath

# Ensure REG_MULTI_SZ written correctly (array becomes multi-string)
New-ItemProperty -Path $PolicyPath -Name $PolicyValueName -PropertyType MultiString -Value $DesiredCurves -Force | Out-Null
Write-Host "[+] Set policy-level EccCurves (REG_MULTI_SZ) to: $DesiredCurveOrderString"

# --- Apply local Schannel ECC value ---
Ensure-Key -Path $LocalPath

# Commonly implemented as REG_SZ with comma+space separated order
New-ItemProperty -Path $LocalPath -Name $LocalValueName -PropertyType String -Value $DesiredCurveOrderString -Force | Out-Null
Write-Host "[+] Set local-level CurveOrder (REG_SZ) to: $DesiredCurveOrderString"
Write-Host ""

# --- Verify ---
Write-Host "[*] Verifying..."
$afterPolicy = Read-Value -Path $PolicyPath -Name $PolicyValueName
$afterLocal  = Read-Value -Path $LocalPath  -Name $LocalValueName

$policyOk = ($null -ne $afterPolicy) -and (($afterPolicy | ForEach-Object { $_.ToString() }) -join ",") -eq (($DesiredCurves) -join ",")
$localOk  = ($afterLocal -eq $DesiredCurveOrderString)

Write-Host "    Policy now: $(
    if ($null -eq $afterPolicy) { '<not set>' } else { ($afterPolicy -join ', ') }
)"
Write-Host "    Local now : $(
    if ($null -eq $afterLocal) { '<not set>' } else { $afterLocal }
)"
Write-Host ""

if ($policyOk -and $localOk) {
    Write-Host "[SUCCESS] ECC Curve Order configured." -ForegroundColor Green
    Write-Host "Reboot recommended."
    exit 0
} else {
    Write-Host "[FAILURE] One or more values did not match the desired configuration." -ForegroundColor Red
    exit 1
}
