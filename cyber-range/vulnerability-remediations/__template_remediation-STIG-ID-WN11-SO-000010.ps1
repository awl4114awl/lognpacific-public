<#
.SYNOPSIS
    Forces STIG WN11-SO-000010 to FAIL by enabling the built-in Guest account.

.DESCRIPTION
    WN11-SO-000010 requires the built-in Guest account to be DISABLED.
    This script enables Guest (and can optionally set a password) so a compliance scan
    should report a FAIL for this control.

.NOTES
    Author       : Jordan Calvert
    Date Created : 2025-12-15
    STIG-ID      : WN11-SO-000010
    Tested On    : Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process Bypass
    PS C:\> .\force-fail-WN11-SO-000010-enable-guest.ps1

.PARAMETER SetPassword
    If specified, will set a random password for Guest to help keep it enabled.

.PARAMETER PasswordLength
    Length of the random password if -SetPassword is used (default 20).
#>

[CmdletBinding()]
param(
    [switch]$SetPassword,
    [ValidateRange(12,64)]
    [int]$PasswordLength = 20
)

function New-RandomPassword {
    param([int]$Length = 20)

    # Exclude confusing chars; include complexity across sets
    $upper   = "ABCDEFGHJKLMNPQRSTUVWXYZ"
    $lower   = "abcdefghijkmnopqrstuvwxyz"
    $digits  = "23456789"
    $special = "!@#$%^&*()-_=+[]{};:,.?"

    $all = ($upper + $lower + $digits + $special).ToCharArray()

    # Guarantee at least one of each category
    $pwdChars = @(
        $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
        $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
        $digits[(Get-Random -Minimum 0 -Maximum $digits.Length)]
        $special[(Get-Random -Minimum 0 -Maximum $special.Length)]
    )

    for ($i = $pwdChars.Count; $i -lt $Length; $i++) {
        $pwdChars += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
    }

    # Shuffle
    -join ($pwdChars | Sort-Object { Get-Random })
}

# --- Safety checks ---
$principal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Error "Run this script as Administrator."
    exit 1
}

try {
    $guest = Get-LocalUser -Name "Guest" -ErrorAction Stop
} catch {
    Write-Error "Could not find local user 'Guest'. Are you on Windows Pro/Enterprise with LocalAccounts available?"
    exit 1
}

Write-Host "Current Guest Enabled state: $($guest.Enabled)"

# Optionally set a password (helps avoid edge cases where enabling may be reverted/blocked)
if ($SetPassword) {
    $pwPlain = New-RandomPassword -Length $PasswordLength
    $secure  = ConvertTo-SecureString $pwPlain -AsPlainText -Force

    try {
        # Requires Windows PowerShell 5.1 / LocalAccounts module
        Set-LocalUser -Name "Guest" -Password $secure -ErrorAction Stop
        Write-Host "Guest password set (random). Save it if you need to log in as Guest:"
        Write-Host "Password: $pwPlain"
    } catch {
        Write-Warning "Could not set Guest password via Set-LocalUser. Trying fallback (net user)..."
        cmd.exe /c "net user Guest $pwPlain" | Out-Null
        Write-Host "Guest password set via net user. Password: $pwPlain"
    }
}

# Enable Guest
try {
    Enable-LocalUser -Name "Guest" -ErrorAction Stop
    Write-Host "Guest account ENABLED."
} catch {
    Write-Warning "Enable-LocalUser failed. Trying fallback (net user)..."
    cmd.exe /c "net user Guest /active:yes" | Out-Null
    Write-Host "Guest account ENABLED (net user fallback)."
}

# Confirm
$guestAfter = Get-LocalUser -Name "Guest"
Write-Host "New Guest Enabled state: $($guestAfter.Enabled)"

Write-Host "`nNext step: re-run your Tenable compliance scan. WN11-SO-000010 should now report FAIL."
