<#
.SYNOPSIS
    Remediates STIG ID WN11-AC-000010 by enforcing the Account lockout threshold
    to 3 invalid logon attempts or fewer (excluding 0, which disables lockout).

.DESCRIPTION
    Uses supported Windows account policy configuration via `net accounts`.
    This control is enforced through the local security policy/LSA, not via a standard registry key.

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/awl4114awl/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-19
    Last Modified   : 2025-12-19
    Version         : 1.0
    STIG-ID         : WN11-AC-000010
    STIG-Title      : Account lockout threshold must be three or less

.TESTED ON
    Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\remediation-WN11-AC-000010.ps1

#>

# -----------------------------
# Admin check
# -----------------------------
$principal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "[!] This script must be run as Administrator." -ForegroundColor Red
    exit 1
}

# -----------------------------
# STIG parameters
# -----------------------------
$stigId = "WN11-AC-000010"

# Target value must be 1-3. (0 disables lockout and is non-compliant)
$targetThreshold = 3

if ($targetThreshold -lt 1 -or $targetThreshold -gt 3) {
    Write-Host "[!] Invalid targetThreshold: $targetThreshold. Must be 1, 2, or 3." -ForegroundColor Red
    exit 1
}

Write-Host "[*] Starting remediation for $stigId ..." -ForegroundColor Cyan

# -----------------------------
# Read current policy (best effort)
# -----------------------------
function Get-LockoutThreshold {
    try {
        $out = (cmd /c "net accounts") 2>$null
        # Matches lines like: "Lockout threshold:                        3"
        $line = $out | Where-Object { $_ -match "Lockout threshold" } | Select-Object -First 1
        if ($null -eq $line) { return $null }

        # Extract first integer on the line
        $m = [regex]::Match($line, "(\d+)")
        if ($m.Success) { return [int]$m.Groups[1].Value }
        return $null
    } catch {
        return $null
    }
}

$currentThreshold = Get-LockoutThreshold
if ($null -ne $currentThreshold) {
    Write-Host "[*] Current lockout threshold: $currentThreshold"
} else {
    Write-Host "[!] Unable to read current lockout threshold (continuing anyway)." -ForegroundColor Yellow
}

# -----------------------------
# Enforce STIG-compliant threshold
# -----------------------------
Write-Host "[*] Setting lockout threshold to $targetThreshold ..."
$setCmd = "net accounts /lockoutthreshold:$targetThreshold"
$null = cmd /c $setCmd

# -----------------------------
# Verify setting applied
# -----------------------------
$verifiedThreshold = Get-LockoutThreshold
if ($null -ne $verifiedThreshold) {
    Write-Host "[*] Verified lockout threshold is now: $verifiedThreshold"
    if ($verifiedThreshold -le 3 -and $verifiedThreshold -ne 0) {
        Write-Host "[+] Remediation complete for $stigId." -ForegroundColor Green
    } else {
        Write-Host "[!] Lockout threshold is not STIG-compliant after change. Current: $verifiedThreshold" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "[!] Could not verify threshold via net accounts output. Recommend reboot + re-check." -ForegroundColor Yellow
}

Write-Host "[i] Recommended: reboot the system." -ForegroundColor Yellow
