<#
.SYNOPSIS
    Remediates STIG ID WN11-AU-000054 by enabling failure auditing for
    Logon/Logoff >> Account Lockout and restoring the local GPO-backed
    Advanced Audit Policy configuration.

.DESCRIPTION
    WN11-AU-000054 requires auditing of account lockout failures.
    Compliance is evaluated based on the effective audit policy, while
    Local Group Policy Editor reflects policy-backed configuration stored
    in audit.csv.

    This script:
      1. Enables failure auditing using auditpol (effective policy)
      2. Recreates the local Advanced Audit Policy configuration file
         (audit.csv) so the setting appears configured in GPEDIT
      3. Forces a Group Policy refresh
      4. Verifies the effective audit state

.NOTES
    Author          : Jordan Calvert
    GitHub          : https://github.com/awl4114awl
    Date Created    : 2025-12-29
    Last Modified   : 2025-12-29
    Version         : 1.2
    STIG-ID         : WN11-AU-000054
    Severity        : Medium (CAT II)

.TESTED ON
    Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:

    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-WN11-AU-000054.ps1
#>

Write-Host "Applying STIG remediation for WN11-AU-000054..." -ForegroundColor Cyan

# ------------------------------------------------------------------
# Step 1: Configure effective audit policy (scanner-enforced)
# ------------------------------------------------------------------
Write-Host "Enabling failure auditing for Account Lockout..." -ForegroundColor Cyan

auditpol /set /subcategory:"Account Lockout" /failure:enable

if ($LASTEXITCODE -ne 0) {
    Write-Host "[!] Failed to configure effective audit policy." -ForegroundColor Red
    exit 1
}

Write-Host "[+] Effective audit policy applied successfully." -ForegroundColor Green

# ------------------------------------------------------------------
# Step 2: Restore Local GPO-backed Advanced Audit Policy (GPEDIT view)
# ------------------------------------------------------------------
Write-Host "Restoring local Advanced Audit Policy configuration..." -ForegroundColor Cyan

$AuditDir = "$env:windir\System32\GroupPolicy\Machine\Microsoft\Windows NT\Audit"
$AuditCsv = Join-Path $AuditDir "audit.csv"

# Ensure directory exists
if (-not (Test-Path $AuditDir)) {
    New-Item -Path $AuditDir -ItemType Directory -Force | Out-Null
}

# Write audit.csv entry for Audit Account Lockout = Failure
$AuditCsvContent = @"
Machine Name,Policy Target,Subcategory,Subcategory GUID,Inclusion Setting,Exclusion Setting,Setting Value
,System,Audit Account Lockout,{0cce9217-69ae-11d9-bed3-505054503030},Failure,,2
"@

Set-Content -Path $AuditCsv -Value $AuditCsvContent -Encoding ASCII -Force

# Refresh policy
gpupdate /force | Out-Null

Write-Host "[+] Local Group Policy audit configuration restored." -ForegroundColor Green

# ------------------------------------------------------------------
# Step 3: Verification
# ------------------------------------------------------------------
Write-Host "Verifying effective audit policy configuration..." -ForegroundColor Cyan

$auditResult = auditpol /get /subcategory:"Account Lockout"
Write-Host $auditResult

if ($auditResult -match "Account Lockout\s+Failure") {
    Write-Host "[+] Verification successful: Account Lockout failure auditing is enabled." -ForegroundColor Green
} else {
    Write-Host "[!] Verification failed: Account Lockout failure auditing is not enabled." -ForegroundColor Red
    exit 1
}

Write-Host "[+] STIG WN11-AU-000054 remediation completed successfully." -ForegroundColor Green
