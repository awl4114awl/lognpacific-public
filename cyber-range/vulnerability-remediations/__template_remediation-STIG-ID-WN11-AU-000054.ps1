<#
.SYNOPSIS
    Remediates STIG ID WN11-AU-000054 by enabling failure auditing for
    Logon/Logoff >> Account Lockout using Advanced Audit Policy.

.DESCRIPTION
    WN11-AU-000054 requires the system to audit account lockout failures.
    This control is enforced through Advanced Audit Policy configuration.
    The script uses auditpol to configure the effective audit policy and
    verifies compliance using actual auditpol output.

.NOTES
    Author          : Jordan Calvert
    GitHub          : https://github.com/awl4114awl
    Date Created    : 2025-12-29
    Last Modified   : 2025-12-29
    Version         : 1.1
    STIG-ID         : WN11-AU-000054
    Severity        : Medium (CAT II)

.TESTED ON
    Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:

    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-WN11-AU-000054.ps1
#>

Write-Host "Applying STIG remediation for WN11-AU-000054..." -ForegroundColor Cyan

# Apply remediation: Enable failure auditing for Account Lockout
$auditCommand = 'auditpol /set /subcategory:"Account Lockout" /failure:enable'
Invoke-Expression $auditCommand

if ($LASTEXITCODE -ne 0) {
    Write-Host "[!] Failed to apply audit policy configuration." -ForegroundColor Red
    exit 1
}

Write-Host "Audit policy applied successfully." -ForegroundColor Green

# Verify effective audit policy
Write-Host "Verifying effective audit policy configuration..." -ForegroundColor Cyan
$auditResult = auditpol /get /subcategory:"Account Lockout"

Write-Host $auditResult

# Validate compliance using actual auditpol output format
if ($auditResult -match "Account Lockout\s+Failure") {
    Write-Host "[+] Verification successful: Account Lockout failure auditing is enabled." -ForegroundColor Green
} else {
    Write-Host "[!] Verification failed: Account Lockout failure auditing is not enabled." -ForegroundColor Red
    exit 1
}

Write-Host "[+] STIG WN11-AU-000054 remediation completed successfully." -ForegroundColor Green
