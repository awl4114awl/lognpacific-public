<#
.SYNOPSIS
    WN11-AU-000500 - Ensure Windows Application event log maximum size is at least 32768 KB (32 MB).

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-12
    Last Modified   : 2025-12-12
    Version         : 1.2
    STIG-ID         : WN11-AU-000500

.USAGE
    Run PowerShell as Administrator:
    PS C:\> .\remediation-WN11-AU-000500.ps1
#>

[CmdletBinding()]
param(
    [ValidateRange(1, 10485760)]
    [int]$MinSizeKB = 32768
)

$ErrorActionPreference = "Stop"

function Test-IsAdmin {
    $id = [Security.Principal.WindowsIdentity]::GetCurrent()
    $p  = New-Object Security.Principal.WindowsPrincipal($id)
    $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

if (-not (Test-IsAdmin)) {
    Write-Error "Run PowerShell as Administrator."
    exit 1
}

$regPath = "HKLM:\SYSTEM\CurrentControlSet\Services\EventLog\Application"
$valueName = "MaxSize"   # stored in KB (DWORD)

Write-Host "WN11-AU-000500 Remediation (Registry Method)"
Write-Host "Target      : Application event log"
Write-Host "Requirement : MaxSize >= $MinSizeKB KB (32 MB)"
Write-Host ""

if (-not (Test-Path $regPath)) {
    Write-Error "Registry path not found: $regPath"
    exit 2
}

# Read current value; if missing, treat as 0
$currentKB = 0
try {
    $currentKB = (Get-ItemProperty -Path $regPath -Name $valueName -ErrorAction Stop).$valueName
} catch {
    $currentKB = 0
}

Write-Host "Current MaxSize: $currentKB KB"

if ($currentKB -ge $MinSizeKB) {
    Write-Host "Compliant: no change needed."
    exit 0
}

Write-Host "Non-compliant: setting MaxSize to $MinSizeKB KB..."
New-ItemProperty -Path $regPath -Name $valueName -Value $MinSizeKB -PropertyType DWord -Force | Out-Null

$verifyKB = (Get-ItemProperty -Path $regPath -Name $valueName -ErrorAction Stop).$valueName
Write-Host "Verified MaxSize: $verifyKB KB"

if ($verifyKB -ge $MinSizeKB) {
    Write-Host "Success: requirement met."
    exit 0
} else {
    Write-Error "Failed to set MaxSize."
    exit 3
}
