<#
.SYNOPSIS
    Implements STIG ID WN11-AU-000500 by ensuring the maximum size of the Windows "Application" event log
    is at least 32768 KB (32 MB).

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-12
    Last Modified   : 2025-12-12
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-AU-000500

.TESTED ON
    Date(s) Tested  :
    Tested By       :
    Systems Tested  :
    PowerShell Ver. :

.USAGE
    Run PowerShell as Administrator, then:
    PS C:\> .\remediation-WN11-AU-000500.ps1

    Optional:
    PS C:\> .\remediation-WN11-AU-000500.ps1 -MinSizeKB 32768
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory = $false)]
    [ValidateRange(1, 10485760)]
    [int]$MinSizeKB = 32768
)

$ErrorActionPreference = "Stop"

function Test-IsAdmin {
    $currentIdentity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentIdentity)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

if (-not (Test-IsAdmin)) {
    Write-Error "This script must be run as Administrator."
    exit 1
}

$channelName = "Application"
$minBytes = [int64]$MinSizeKB * 1024

Write-Host "WN11-AU-000500 Remediation"
Write-Host "Target log   : $channelName"
Write-Host "Minimum size : $MinSizeKB KB ($minBytes bytes)"
Write-Host ""

try {
    # Read current max size via wevtutil output (reliable across classic/modern channels)
    $slOutput = & wevtutil sl $channelName 2>&1
    if ($LASTEXITCODE -ne 0) { throw "wevtutil sl failed: $slOutput" }

    $currentBytes = $null
    foreach ($line in ($slOutput -split "`r?`n")) {
        if ($line -match '^\s*maxSize:\s*(\d+)\s*$') {
            $currentBytes = [int64]$Matches[1]
            break
        }
    }

    if ($null -eq $currentBytes) {
        throw "Unable to parse current maxSize from wevtutil output."
    }

    Write-Host "Current maxSize: $currentBytes bytes ($([math]::Round($currentBytes / 1KB)) KB)"

    if ($currentBytes -ge $minBytes) {
        Write-Host "Compliant: Application log max size already meets or exceeds the requirement."
        exit 0
    }

    Write-Host "Non-compliant: updating max size to $minBytes bytes..."
    $setOutput = & wevtutil sl $channelName /ms:$minBytes 2>&1
    if ($LASTEXITCODE -ne 0) { throw "wevtutil sl /ms failed: $setOutput" }

    # Verify
    $verifyOutput = & wevtutil sl $channelName 2>&1
    if ($LASTEXITCODE -ne 0) { throw "wevtutil sl verify failed: $verifyOutput" }

    $verifiedBytes = $null
    foreach ($line in ($verifyOutput -split "`r?`n")) {
        if ($line -match '^\s*maxSize:\s*(\d+)\s*$') {
            $verifiedBytes = [int64]$Matches[1]
            break
        }
    }

    if ($null -eq $verifiedBytes) {
        throw "Unable to parse verified maxSize from wevtutil output."
    }

    Write-Host "Verified maxSize: $verifiedBytes bytes ($([math]::Round($verifiedBytes / 1KB)) KB)"

    if ($verifiedBytes -ge $minBytes) {
        Write-Host "Success: WN11-AU-000500 requirement is now met."
        exit 0
    } else {
        throw "Update did not persist. Verified size is still below minimum."
    }
}
catch {
    Write-Error "Remediation failed: $($_.Exception.Message)"
    exit 2
}
