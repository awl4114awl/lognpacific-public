<#
.SYNOPSIS
    Remediates STIG ID WN11-AU-000500 by enforcing the Application Event Log maximum size to 32768 KB (32 MB)
    using the Administrative Templates policy registry key. Also sets the runtime key for consistency.

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-12
    Last Modified   : 2025-12-12
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-AU-000500

.TESTED ON
    Systems Tested  : Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process Bypass
    PS C:\> .\remediation-WN11-AU-000500.ps1

    Note:
    In some lab environments, gpupdate can remove policy values if the Local GPO setting is Disabled/Not Configured.
    This script intentionally does NOT run gpupdate to avoid the policy engine deleting the value before a rescan.
#>

[CmdletBinding()]
param(
    [ValidateRange(32768, 10485760)]
    [int]$TargetKB = 32768
)

$ErrorActionPreference = "Stop"

function Test-IsAdmin {
    $id = [Security.Principal.WindowsIdentity]::GetCurrent()
    $p  = New-Object Security.Principal.WindowsPrincipal($id)
    return $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

if (-not (Test-IsAdmin)) {
    Write-Error "This script must be run as Administrator."
    exit 1
}

$PolicyKey  = "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application"
$RuntimeKey = "HKLM\SYSTEM\CurrentControlSet\Services\EventLog\Application"
$ValueName  = "MaxSize"

Write-Host "WN11-AU-000500 Remediation"
Write-Host "Enforcing Application Event Log MaxSize = $TargetKB KB (policy + runtime)"
Write-Host ""

# Ensure policy key exists (Administrative Templates policy storage)
& "$env:windir\System32\reg.exe" ADD "$PolicyKey" /f | Out-Null

# Set policy value (what STIG audits commonly validate)
& "$env:windir\System32\reg.exe" ADD "$PolicyKey" /v $ValueName /t REG_DWORD /d $TargetKB /f | Out-Null

# Set runtime value too (good hygiene / consistency)
& "$env:windir\System32\reg.exe" ADD "$RuntimeKey" /v $ValueName /t REG_DWORD /d $TargetKB /f | Out-Null

# Verify immediately
Write-Host "Policy verification:"
& "$env:windir\System32\reg.exe" QUERY "$PolicyKey" /v $ValueName
Write-Host ""

Write-Host "Runtime verification:"
& "$env:windir\System32\reg.exe" QUERY "$RuntimeKey" /v $ValueName
Write-Host ""

Write-Host "Done. Start your Tenable rescan now to capture PASS."
exit 0
