<#
.SYNOPSIS
    Remediates STIG ID WN11-AU-000500 by enforcing the Application Event Log maximum size to 32768 KB (32 MB)
    via Administrative Template policy (HKLM\SOFTWARE\Policies\...) and ensuring runtime value matches.

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-12
    Last Modified   : 2025-12-12
    Version         : 2.0
    STIG-ID         : WN11-AU-000500

.TESTED ON
    Systems Tested  : Windows 11 (25H2 Pro)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process Bypass
    PS C:\> .\remediation-WN11-AU-000500.ps1

    Optional:
    PS C:\> .\remediation-WN11-AU-000500.ps1 -TargetKB 32768
#>

[CmdletBinding()]
param(
    [ValidateRange(32768, 10485760)]
    [int]$TargetKB = 32768
)

$ErrorActionPreference = "Stop"

function Test-IsAdmin {
    $id = [Security.Principal.WindowsIdentity]::GetCurrent()
    $p  = New-Object Security.Principal.WindowsPrincipal($id)
    return $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

if (-not (Test-IsAdmin)) {
    Write-Error "Run PowerShell as Administrator."
    exit 1
}

$policyKey = "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application"
$localKey  = "HKLM\SYSTEM\CurrentControlSet\Services\EventLog\Application"
$valueName = "MaxSize"

Write-Host "WN11-AU-000500 Remediation"
Write-Host "Enforcing Application Event Log MaxSize = $TargetKB KB (policy + runtime)"
Write-Host ""

# --- ENFORCE POLICY (this is what STIG audits commonly check) ---
& "$env:windir\System32\reg.exe" ADD "$policyKey" /f | Out-Null
& "$env:windir\System32\reg.exe" ADD "$policyKey" /v $valueName /t REG_DWORD /d $TargetKB /f | Out-Null

# --- ENSURE RUNTIME VALUE MATCHES (not always required for the audit, but good hygiene) ---
& "$env:windir\System32\reg.exe" ADD "$localKey" /v $valueName /t REG_DWORD /d $TargetKB /f | Out-Null

# Refresh policy (optional but useful for your lab)
& gpupdate /target:computer /force | Out-Null

# --- VERIFY POLICY ---
$policyVerify = & "$env:windir\System32\reg.exe" QUERY "$policyKey" /v $valueName 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Error "Policy verification failed. reg.exe output: $policyVerify"
    exit 2
}

# --- VERIFY RUNTIME ---
$localVerify = & "$env:windir\System32\reg.exe" QUERY "$localKey" /v $valueName 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Error "Runtime verification failed. reg.exe output: $localVerify"
    exit 3
}

Write-Host "Policy key verified:"
Write-Host $policyVerify
Write-Host ""
Write-Host "Runtime key verified:"
Write-Host $localVerify
Write-Host ""
Write-Host "Success: WN11-AU-000500 enforced. Reboot VM (recommended) and rescan to show PASS."
exit 0
