<#
.SYNOPSIS
    FORCED remediation for STIG ID WN11-AU-000500.
    Sets the Windows Application event log maximum size to exactly 32768 KB (32 MB),
    regardless of current value.

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-12
    Last Modified   : 2025-12-12
    Version         : 1.3
    STIG-ID         : WN11-AU-000500

.USAGE
    Run PowerShell as Administrator:
    PS C:\> .\force-remediation-WN11-AU-000500.ps1
#>

$ErrorActionPreference = "Stop"

function Test-IsAdmin {
    $id = [Security.Principal.WindowsIdentity]::GetCurrent()
    $p  = New-Object Security.Principal.WindowsPrincipal($id)
    $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

if (-not (Test-IsAdmin)) {
    Write-Error "This script must be run as Administrator."
    exit 1
}

$regPath  = "HKLM:\SYSTEM\CurrentControlSet\Services\EventLog\Application"
$value    = "MaxSize"
$targetKB = 32768   # 32 MB per STIG

Write-Host "WN11-AU-000500 FORCED Remediation"
Write-Host "Target log : Application"
Write-Host "Setting   : $targetKB KB (32 MB)"
Write-Host ""

if (-not (Test-Path $regPath)) {
    Write-Error "Registry path not found: $regPath"
    exit 2
}

# Force set (overwrite regardless of existing value)
Set-ItemProperty -Path $regPath -Name $value -Type DWord -Value $targetKB

# Verify
$verified = (Get-ItemProperty -Path $regPath -Name $value -ErrorAction Stop).$value

Write-Host "Verified MaxSize: $verified KB"

if ($verified -eq $targetKB) {
    Write-Host "Success: WN11-AU-000500 enforced exactly as required."
    exit 0
} else {
    Write-Error "Verification failed. Expected $targetKB KB, got $verified KB."
    exit 3
}
