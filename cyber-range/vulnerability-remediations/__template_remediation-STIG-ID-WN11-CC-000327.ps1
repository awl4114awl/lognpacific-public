<#
.SYNOPSIS
    Remediates STIG ID WN11-CC-000327 by enabling PowerShell Transcription
    via registry-based policy values (no gpupdate).

.DESCRIPTION
    Creates/updates the registry policy keys used by Group Policy for PowerShell
    Transcription and enforces STIG-aligned settings:
      - EnableTranscripting = 1
      - EnableInvocationHeader = 1
      - OutputDirectory set to a secure location

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-22
    Last Modified   : 2025-12-22
    Version         : 1.0
    STIG-ID         : WN11-CC-000327

.TESTED ON
    Systems Tested  : Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-WN11-CC-000327.ps1
#>

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

# --- Admin check ---
$isAdmin = ([Security.Principal.WindowsPrincipal] `
    [Security.Principal.WindowsIdentity]::GetCurrent()
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

if (-not $isAdmin) {
    throw "This script must be run as Administrator."
}

# --- Variables ---
$RegPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription"
$OutputDirectory = "C:\PowerShell_Transcripts"

Write-Host "=== Remediating STIG WN11-CC-000327 (PowerShell Transcription) ==="

# --- Ensure registry key exists ---
if (-not (Test-Path $RegPath)) {
    New-Item -Path $RegPath -Force | Out-Null
    Write-Host "[+] Created registry policy key"
} else {
    Write-Host "[*] Registry policy key already exists"
}

# --- Ensure transcript directory exists ---
if (-not (Test-Path $OutputDirectory)) {
    New-Item -Path $OutputDirectory -ItemType Directory -Force | Out-Null
    Write-Host "[+] Created transcript directory: $OutputDirectory"
} else {
    Write-Host "[*] Transcript directory already exists"
}

# --- Apply STIG-required values ---
Set-ItemProperty -Path $RegPath -Name "EnableTranscripting"    -Type DWord  -Value 1
Set-ItemProperty -Path $RegPath -Name "EnableInvocationHeader" -Type DWord  -Value 1
Set-ItemProperty -Path $RegPath -Name "OutputDirectory"        -Type String -Value $OutputDirectory

Write-Host "[+] Applied registry-based policy values"

# --- Verification ---
$CurrentState = Get-ItemProperty -Path $RegPath

Write-Host ""
Write-Host "Current Policy State:"
Write-Host "EnableTranscripting     : $($CurrentState.EnableTranscripting)"
Write-Host "EnableInvocationHeader  : $($CurrentState.EnableInvocationHeader)"
Write-Host "OutputDirectory         : $($CurrentState.OutputDirectory)"
Write-Host ""

if ($CurrentState.EnableTranscripting -eq 1 -and
    $CurrentState.EnableInvocationHeader -eq 1 -and
    $null -ne $CurrentState.OutputDirectory) {

    Write-Host "[SUCCESS] STIG WN11-CC-000327 remediation applied successfully." -ForegroundColor Green
    Write-Host "A reboot is recommended."
}
else {
    Write-Host "[FAILURE] One or more required values were not applied correctly." -ForegroundColor Red
    exit 1
}
