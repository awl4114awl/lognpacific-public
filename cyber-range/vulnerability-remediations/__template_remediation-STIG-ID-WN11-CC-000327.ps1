<#
.SYNOPSIS
    Remediates STIG ID WN11-CC-000327 by enabling PowerShell Transcription
    via registry-based policy values.

.DESCRIPTION
    Creates/updates the registry policy keys used by Group Policy for PowerShell
    Transcription and enforces STIG-aligned settings:
      - EnableTranscripting = 1
      - EnableInvocationHeader = 1
      - OutputDirectory set to a secure location (local or UNC)

.NOTES
    Author          : Jordan Calvert
    LinkedIn        : linkedin.com/in/jordanryancalvert/
    GitHub          : github.com/awl4114awl
    Date Created    : 2025-12-22
    Last Modified   : 2025-12-22
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-CC-000327

.TESTED ON
    Systems Tested  : Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    PS C:\> .\__template_remediation-STIG-ID-WN11-CC-000327.ps1

    Optional parameters:
    PS C:\> .\__template_remediation-STIG-ID-WN11-CC-000327.ps1 -OutputDirectory "C:\PowerShell_Transcripts"
    PS C:\> .\__template_remediation-STIG-ID-WN11-CC-000327.ps1 -OutputDirectory "\\SERVER\Share\PS-Transcripts" -SkipGpupdate

#>

[CmdletBinding()]
param(
    # STIG guidance prefers a central log server / secure location.
    # In a lab, a local folder is fine to validate the control.
    [Parameter(Mandatory = $false)]
    [ValidateNotNullOrEmpty()]
    [string]$OutputDirectory = "C:\PowerShell_Transcripts",

    # Force a Group Policy refresh after applying the registry policy settings.
    [Parameter(Mandatory = $false)]
    [switch]$SkipGpupdate
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

# --- Helpers ---
function Assert-Admin {
    $isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()
    ).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

    if (-not $isAdmin) {
        throw "This script must be run as Administrator."
    }
}

function Ensure-Directory {
    param([Parameter(Mandatory=$true)][string]$Path)

    # If UNC path, just validate format and warn if not reachable right now.
    if ($Path -like "\\*") {
        Write-Host "[*] OutputDirectory is a UNC path: $Path"
        if (-not (Test-Path $Path)) {
            Write-Warning "UNC path is not reachable from this system right now. The policy will still be set, but transcripts may fail to write until the share is accessible and permissions are correct."
        }
        return
    }

    if (-not (Test-Path $Path)) {
        New-Item -Path $Path -ItemType Directory -Force | Out-Null
        Write-Host "[+] Created directory: $Path"
    } else {
        Write-Host "[*] Directory already exists: $Path"
    }
}

function Get-PolicyState {
    param([Parameter(Mandatory=$true)][string]$RegPath)

    $state = [ordered]@{
        EnableTranscripting     = $null
        EnableInvocationHeader  = $null
        OutputDirectory         = $null
        PathExists              = $false
    }

    if (Test-Path $RegPath) {
        $state.PathExists = $true
        $props = Get-ItemProperty -Path $RegPath -ErrorAction SilentlyContinue
        if ($null -ne $props) {
            if ($props.PSObject.Properties.Name -contains "EnableTranscripting") { $state.EnableTranscripting = $props.EnableTranscripting }
            if ($props.PSObject.Properties.Name -contains "EnableInvocationHeader") { $state.EnableInvocationHeader = $props.EnableInvocationHeader }
            if ($props.PSObject.Properties.Name -contains "OutputDirectory") { $state.OutputDirectory = $props.OutputDirectory }
        }
    }

    return $state
}

# --- Main ---
try {
    Assert-Admin

    $regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\Transcription"

    Write-Host "=== STIG Remediation: WN11-CC-000327 (PowerShell Transcription) ==="
    Write-Host "[*] Target registry policy path: $regPath"
    Write-Host "[*] Desired OutputDirectory: $OutputDirectory"
    Write-Host ""

    $before = Get-PolicyState -RegPath $regPath
    Write-Host "[*] Current policy state (before):"
    $before | Format-List | Out-String | Write-Host

    # Ensure transcription policy key exists
    if (-not (Test-Path $regPath)) {
        New-Item -Path $regPath -Force | Out-Null
        Write-Host "[+] Created registry policy key: $regPath"
    } else {
        Write-Host "[*] Registry policy key already exists."
    }

    # Ensure destination exists (local) or is at least identified (UNC)
    Ensure-Directory -Path $OutputDirectory

    # Apply STIG-aligned policy values
    Set-ItemProperty -Path $regPath -Name "EnableTranscripting"    -Type DWord  -Value 1
    Set-ItemProperty -Path $regPath -Name "EnableInvocationHeader" -Type DWord  -Value 1
    Set-ItemProperty -Path $regPath -Name "OutputDirectory"        -Type String -Value $OutputDirectory

    Write-Host "[+] Applied policy values:"
    Write-Host "    - EnableTranscripting    = 1"
    Write-Host "    - EnableInvocationHeader = 1"
    Write-Host "    - OutputDirectory        = $OutputDirectory"
    Write-Host ""

    if (-not $SkipGpupdate) {
        Write-Host "[*] Refreshing Group Policy (gpupdate /force)..."
        & gpupdate /force | Out-Null
        Write-Host "[+] Group Policy refresh complete."
        Write-Host ""
    } else {
        Write-Host "[*] Skipping gpupdate (per -SkipGpupdate)."
        Write-Host ""
    }

    $after = Get-PolicyState -RegPath $regPath
    Write-Host "[*] Current policy state (after):"
    $after | Format-List | Out-String | Write-Host

    # Quick pass/fail evaluation for the settings we enforce
    $pass = ($after.EnableTranscripting -eq 1) -and
            ($after.EnableInvocationHeader -eq 1) -and
            ([string]::IsNullOrWhiteSpace($after.OutputDirectory) -eq $false)

    if ($pass) {
        Write-Host "[SUCCESS] remediation applied. Reboot recommended." -ForegroundColor Green
    } else {
        Write-Host "[WARNING] Policy values were not all set as expected. Review output above." -ForegroundColor Yellow
        exit 1
    }
}
catch {
    Write-Error $_
    exit 1
}