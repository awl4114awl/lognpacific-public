<#
.SYNOPSIS
    Remediates STIG ID WN11-SO-000070 by enforcing the "Interactive logon: Machine inactivity limit"
    to 900 seconds (15 minutes) or less (and not 0).

.DESCRIPTION
    STIG: WN11-SO-000070
    Requirement: Configure "Interactive logon: Machine inactivity limit" to 900 seconds or less,
    excluding 0 (0 disables the control).

    This setting maps to:
    HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\InactivityTimeoutSecs (DWORD)

.NOTES
    Author          : Jordan Calvert
    Date Created    : 2025-12-17
    STIG-ID         : WN11-SO-000070
    Tested On       : Windows 11 Pro (25H2)

.USAGE
    Run PowerShell as Administrator:
    PS C:\> Set-ExecutionPolicy -Scope Process Bypass
    PS C:\> .\remediation-WN11-SO-000070.ps1

.PARAMETER TimeoutSeconds
    Desired inactivity timeout in seconds.
    Must be 1..900 (0 is not allowed). Default: 900.
#>

[CmdletBinding()]
param(
    [ValidateRange(1,900)]
    [int]$TimeoutSeconds = 900
)

# --- Admin check ---
$principal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
if (-not $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Error "Run this script as Administrator."
    exit 1
}

$regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
$valueName = "InactivityTimeoutSecs"

# --- Read current value (if present) ---
$currentValue = $null
try {
    $currentValue = (Get-ItemProperty -Path $regPath -Name $valueName -ErrorAction Stop).$valueName
} catch {
    # Value does not exist yet
}

Write-Host "STIG WN11-SO-000070 remediation"
Write-Host "Registry Path : $regPath"
Write-Host "Value Name    : $valueName"
Write-Host "Current Value : $($currentValue -as [string] -replace '^$', 'Not Set')"
Write-Host "Target Value  : $TimeoutSeconds"

# --- Ensure key exists (should, but safe) ---
if (-not (Test-Path $regPath)) {
    New-Item -Path $regPath -Force | Out-Null
}

# --- Apply setting ---
try {
    New-ItemProperty -Path $regPath -Name $valueName -PropertyType DWord -Value $TimeoutSeconds -Force | Out-Null
    Write-Host "Applied: $valueName = $TimeoutSeconds (DWORD)"
} catch {
    Write-Error "Failed to set registry value. Error: $($_.Exception.Message)"
    exit 1
}

# --- Verify ---
$afterValue = (Get-ItemProperty -Path $regPath -Name $valueName).$valueName
Write-Host "New Value     : $afterValue"

# --- Refresh policy (best effort) ---
try {
    Write-Host "`nRefreshing Group Policy..."
    gpupdate /force | Out-Null
    Write-Host "Group Policy refreshed."
} catch {
    Write-Warning "gpupdate failed or is unavailable. A reboot will still apply the setting."
}

Write-Host "`nNext step: reboot the VM!"
